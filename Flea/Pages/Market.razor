@page "/Event/{EventId:int}/Market"
@using Flea.Models
@using System.Globalization
@using Flea.Utility
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BingoContext> _dbFactory

<HeaderTitle Value="@(titlePrefix + " " + _titleDate)"/>

<div>
    <div class="view-head">
        <input class="search-input" type="search" value="" placeholder="SÃ¸g efter booking" @oninput="Search">
        <button class="button blue float-right">Gulv Plans Oversigt</button>
    </div>
    @if (_shownReservation is not null && _shownReservation.Any())
    {
        @foreach (var reservation in _shownReservation)
        {
            <div>
                <MarketUserListItem Reservation="reservation"></MarketUserListItem>
            </div>
        }
        <div style="display: inline-block"></div>
    }
    else
    {
        <h2>Der er ingen bookinger at vise...</h2>
    }
</div>

@code {
    private string titlePrefix = "Oversigt over Loppemarkedet den";
    private string _titleDate = "28. februar, 2021";

    [Parameter]
    public int EventId { get; set; }

    public Event Event = null!;

    private Modal _child = null!;
    private Reservation _temp = new();
    private string _lastSearchTerm = string.Empty;

    private List<Reservation>? _reservations;
    private IEnumerable<Reservation>? _shownReservation;

    // Searchbar function
    public void Search(ChangeEventArgs e) => Search(e.Value?.ToString()!.ToLower() ?? "");

    public void Search(string searchTerm)
    {
    // If no input show everything
        if (searchTerm == "")
        {
            _shownReservation = _reservations;
        }
        else if (char.IsDigit(searchTerm[0]))
        {
    // Finds by Booths
            _shownReservation = from c
                in _reservations
                where c.TableCount.ToString().Contains(searchTerm)
                select c;
        }
        else if (searchTerm.Contains("betalt"))
        {
    // Finds by betalt or ej betalt
            _shownReservation = from c
                in _reservations
                where c.Paid != searchTerm.Contains("ej")
                select c;
        }
        else
        {
    // Finds by name
            _shownReservation = from c
                in _reservations
                where c.ReservationOwner.Name.ToLower().Contains(searchTerm)
                select c;
        }
        _lastSearchTerm = searchTerm;
    }

    private async Task UpdateReservationList()
    {
        _reservations = await _dbFactory.Get<BingoContext, Reservation>()
            .Where(reservation => reservation.Event.Id == EventId)
            .Include(reservation => reservation.ReservationOwner)
            .All();
        Search(_lastSearchTerm);
    }

    protected override async Task OnInitializedAsync()
    {
        var e = await _dbFactory.Get<BingoContext, Event>()
            .First(e => e.Id == EventId);

        Event = e ?? throw new Exception("TODO create good error for user");
        _temp = new Reservation(1, 1, false, "", new Customer("", ""), Event);

        var eventDate = Event.DateTime;

        _titleDate = eventDate.ToString("d. MMMM, yyyy", CultureInfo.CreateSpecificCulture("da-DK"));

        await UpdateReservationList();
        await base.OnInitializedAsync();
    }

}